<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
 <!--
  In this implementation, JQuery is used to update records modified on the
  individual record panels.
  The individual value being sent to the server is not JSON, but URL-encoded
  text field values, as dictated by the default JQuery setting
  contentType: application/x-www-form-urlencoded, which is common.
  To serialize the records, the JQuery.param method is used in conjunction
  with the local simpleValue method to create the URL encoded content for the
  active table. This combination is properly deserialized by the associated
  ApiController at the server Web API 2 endpoint.
 -->
 <title>BankCore featuring Kendo UI MVVM JQuery, ASP.NET and REST</title>
 <!-- Base formatting. -->
 <link href="Default.css" rel="stylesheet" />
 <!-- Common Kendo UI CSS for web widgets and widgets for data visualization. -->
 <link href="styles/kendo.common.min.css" rel="stylesheet" />
 <!-- The following doesn't set a theme. -->
 <!-- Default Kendo UI theme CSS for web widgets and widgets for data visualization. -->
 <!-- <link href="styles/kendo.default.min.css" rel="stylesheet" /> -->
 <!-- Set a theme -->
 <link href="styles/kendo.blueopal.min.css" rel="stylesheet" />
 <!-- jQuery Javascript from VS2013 -->
 <script src="Scripts/jquery-1.10.2.min.js"></script>
 <!-- Kendo UI Combined. -->
 <script src="js/kendo.all.min.js"></script>
</head>
<body>
 <div id="pnlMain">
  <div id="tctlMain">
   <div class="demo-section k-content">
    <div id="tabstrip">
     <ul>
      <li class="k-state-active">Customers</li>
      <li>Accounts</li>
      <li>Branches</li>
      <li>Employees</li>
     </ul>
     <div>
      <!-- Customers -->
      <span class="tpanel">Select a customer to edit or view.</span>
      <div class="tcontent">
       <div id="dgCustomers"></div>
      </div>
     </div>
     <div>
      <!-- Accounts -->
      <span class="tpanel">Select an account to edit or view.</span>
      <div class="tcontent">
       <h2>&nbsp;</h2>
      </div>
     </div>
     <div>
      <!-- Branches -->
      <span class="tpanel">&nbsp;</span>
      <div class="tcontent">
       <h2>&nbsp;</h2>
      </div>
     </div>
     <div>
      <!-- Employees -->
      <span class="tpanel">&nbsp;</span>
      <div class="tcontent">
       <h2>&nbsp;</h2>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
 <div id="pnlCustomer" class="hidden">
  <div class="backButton">
   <a onclick="activateMain();"><img src="Images/BackArrow.png" /> 
   Back to main form</a></div>
  <div class="formBody" style="width:400px">
   <h2>Customer</h2>
   <div id="frmCustomer">
    <!--
    1. When binding to a single record that has been retrieved from the server, 
    an array is expected anyway. When using a single record source for an 
    object such as a textbox, the correct binding path is 
    packageSource.data()[0].FieldName where FieldName is the name of each field 
    to be bound.
    2. When binding to the item selected from a local record set, such as that 
    driven by the kendogrid control, the correct binding path is
    selectedItem.FieldName
    In this case, an additional property like 'selectedItem' should be placed 
    in the observable, and set from the event in the multi-record controller 
    hosting the selection. In this case, the multi-record controller is a grid, 
    and selectedItem is being set from the kendogrid.change event.
    -->
    <div class="demo-section k-content">
     <table class="formFields">
      <tr>
       <td>Ticket:</td>
       <td><input id="customerTicket" type="text" class="k-textbox" 
        data-bind="value: selectedItem.CustomerTicket" />
       </td>
      </tr>
      <tr>
       <td>Name:</td>
       <td><input id="customerName" type="text" class="k-textbox" 
        data-bind="value: selectedItem.Name, events:{change:textChanged}" />
       </td>
      </tr>
      <tr>
       <td>Address:</td>
       <td><input id="customerAddress" type="text" class="k-textbox"
        data-bind="value: selectedItem.Address, events:{change:textChanged}" />
       </td>
      </tr>
      <tr>
       <td>City:</td>
       <td><input id="customerCity" type="text" class="k-textbox"
        data-bind="value: selectedItem.City, events:{change:textChanged}" />
       </td>
      </tr>
      <tr>
       <td>State:</td>
       <td><input id="customerState" type="text" class="k-textbox"
        data-bind="value: selectedItem.State, events:{change:textChanged}" />
       </td>
      </tr>
      <tr>
       <td>Zip Code:</td>
       <td><input id="customerZipCode" type="text" class="k-textbox"
        data-bind="value: selectedItem.ZipCode, events:{change:textChanged}" />
       </td>
      </tr>
      <tr>
       <td>&nbsp;</td>
       <td><button data-role="button" data-icon="edit"
        data-bind="visible:isSaveVisible, enabled:isSaveEnabled, events:{click:saveClicked}"
        style="width:180px">Save</button>
       </td>
      </tr>
     </table>
    </div>
   </div>
  </div>
 </div>
 <div id="pnlAccount" class="hidden">

 </div>
 <div id="pnlBranch" class="hidden">

 </div>
 <div id="pnlEmployee" class="hidden">

 </div>
 <script>
  // Activate the main panel.
  function activateMain()
  {
   if(!$("#pnlCustomer").hasClass("hidden"))
   {
    $("#pnlCustomer").addClass("hidden");
   }
   if(!$("#pnlAccount").hasClass("hidden"))
   {
    $("#pnlAccount").addClass("hidden");
   }
   if(!$("#pnlBranch").hasClass("hidden"))
   {
    $("#pnlBranch").addClass("hidden");
   }
   if(!$("#pnlEmployee").hasClass("hidden"))
   {
    $("#pnlEmployee").addClass("hidden");
   }
   $("#pnlMain").removeClass("hidden");
  }
  // Set a control's behavior to read only.
  function setReadOnly(name)
  {
   $(name).attr("readonly", true);
   $(name).addClass("rdonly");
   $(name).attr("tabindex", -1);
  }
  // Return a simple name/value list for the specified table.
  function simpleValue(table, item)
  {
   var rv = {};
   switch(table)
   {
    case "Account":
     rv = {
      "AccountID": item.AccountID.toString(),
      "AccountTicket": item.AccountTicket.toString(),
      "CustomerID": item.CustomerID.toString(),
      "AccountStatus": item.AccountStatus.toString(),
      "BalanceAvailable": item.BalanceAvailable.toString(),
      "BalancePending": item.BalancePending.toString(),
      "DateOpened": item.DateOpened.toString(),
      "DateClosed": item.DateClosed.toString(),
      "DateLastActivity": item.DateLastActivity.toString(),
      "BranchID": item.BranchID.toString(),
      "EmployeeID": item.EmployeeID.toString()
     };
     break;
    case "Customer":
     rv = {
      "CustomerID": item.CustomerID.toString(),
      "CustomerTicket": item.CustomerTicket.toString(),
      "Name": item.Name.toString(),
      "Address": item.Address.toString(),
      "City": item.City.toString(),
      "State": item.State.toString(),
      "ZipCode": item.ZipCode.toString(),
      "TIN": item.TIN.toString()
     };
     break;
   }
   return rv;
  }
  // The document is ready. Launch the single page application.
  $(document).ready(function()
  {
   try
   {
    // *** Model Definitions. ***
    var accountModel = new kendo.data.Model.define({
     id: "AccountID",
     fields: {
      AccountID: {},
      AccountTicket: {},
      CustomerID: {},
      AccountStatus: {},
      BalanceAvailable: {},
      BalancePending: {},
      DateOpened: {},
      DateClosed: {},
      DateLastActivity: {},
      BranchID: {},
      EmployeeID: {}
     }
    });

    var customerModel = new kendo.data.Model.define({
     id: "CustomerID",
     fields: {
      CustomerID: {},
      CustomerTicket: {},
      Name: {},
      Address: {},
      City: {},
      State: {},
      ZipCode: {},
      TIN: {}
     }
    });

    // *** DataSource Definitions ***
    var accountData = new kendo.data.DataSource({
     schema: accountModel,
     batch: true,
     transport: {
      read: {
       url: "api/Accounts/",
       dataType: "json"
      }
     }
    });

    var customerData = new kendo.data.DataSource({
     schema: customerModel,
     batch: true,
     transport: {
      read: {
       url: "api/Customers/",
       dataType: "json"
      },
      //update: {
      // // Notice that an update won't occur on this DataSource if a model with
      // // an id: hasn't been defined. In this case, id: "CustomerID" is defined
      // // in the model.
      // url: "api/Customers/",
      // dataType: "json",
      // type: "POST"
      //},
      update: function(options)
      {
       console.log("Starting update...");
       $.ajax({
        url: "api/Customers/",
        dataType: "json",
        type: "POST",
        // send the updated data items as the "models"
        // service parameter encoded in JSON.
        data: { models: kendo.stringify(options.data.models) },
        success: function(result)
        {
         // Notify the data source that the update was successful.
         options.success(result);
        },
        error: function(result)
        {
         // Notify the data source that an error occurred.
         options.error(result);
        }
       });
      },
      destroy: {
       url: "api/Customers/",
       dataType: "json",
       type: "DELETE"
      },
      parameterMap: function(options, operation)
      {
       //if(operation === "update")
       //{
       // // During an update, any dates need to be formatted in a way they can
       // // be consumed by WebAPI.
       // var d = new Date(options.DateOpened);
       // options.DateOpened = kendo.toString(d, "MM/dd/yyyy");
       //}
       return options;
      }
     },
     pageSize: 20
    });

    // *** View Model Definitions ***
    var accountViewModel = kendo.observable({
     packageSource: accountData,
     selectedItem: null,
     hasChanges: false,
     isSaveVisible: true,
     isSaveEnabled: false,
     textChanged: function(e)
     {
      // The e parameter contains bubbles, cancelable, target, and type
      // properties.
      // The target property identifies the calling object.
      console.log("Text changed Event: " +
       e.target.id + " " + e.target.value);
      console.log(" DataSource hasChanges(): " +
       this.packageSource.hasChanges());
      this.set("isSaveEnabled", true);
      this.set("hasChanges", true);
      //this.packageSource.hasChanges = true;
     },
     saveClicked: function(e)
     {
      // Store the selectedItem unconditionally.
      var id = 0;    // Record ID.
      var il = 0;    // View Length.
      var ix = 0;    // Record index.
      var pd = "";   // Post Data.
      var ur = "";   // URL to POST.
      var vw = null; // Available Records.
      var vx = null; // Current Record.
      if(this.selectedItem != null)
      {
       id = this.selectedItem.AccountID;
       vw = this.packageSource.data();
       il = vw.length;
       for(ix = 0; ix < il; ix++)
       {
        if(vw[ix].AccountID == id)
        {
         // Record ID found.
         vx = vw[ix];
         //vx.dirty = true;
         console.log("Change Override: " + kendo.stringify(vx));
         ur = "api/Accounts/" + vx.AccountID.toString();
         pd = $.param(simpleValue("Account", vx), true);
         console.log("Prepare to send: " + pd);
         console.log(" to : " + ur);
         $.ajax({
          dataType: "json",
          type: "POST",
          url: ur,
          data: pd,
          success: function(result)
          {
           console.log(" Record stored successfully...");
          },
          error: function(result)
          {
           console.log(" Error storing record...");
          }
         });
         break;
        }
       }
       console.log("Save clicked Event.");
       this.set("isSaveEnabled", false);
       this.set("hasChanges", false);
      }
     }
    });

    var customerViewModel = kendo.observable({
     packageSource: customerData,
     // The selected item belongs in the observable.
     selectedItem: null,
     hasChanges: false,
     save: function() {
      this.packageSource.sync();
      this.set("hasChanges", false);
     },
     remove: function() {
      if(confirm("Are you sure you wish to delete this record?"))
      {
       console.log("Event: [remove] on customerViewModel...");
       this.packageSource.remove(this.selectedItem);
       this.set("selectedItem", this.packageSource.view()[0]);
       this.change();
      }
     },
     showForm: function() {
      return this.get("selectedItem") != null;
     },
     change: function()
     {
      console.log("Event: [change] on customerViewModel...");
      //this.packageSource.hasChanges = true;
      this.set("hasChanges", true);
     },
     isSaveVisible: true,
     isSaveEnabled: false,
     textChanged: function(e)
     {
      // The e parameter contains bubbles, cancelable, target, and type
      // properties.
      // The target property identifies the calling object.
      console.log("Text changed Event: " +
       e.target.id + " " + e.target.value);
      console.log(" DataSource hasChanges(): " +
       this.packageSource.hasChanges());
      this.set("isSaveEnabled", true);
      this.set("hasChanges", true);
      //this.packageSource.hasChanges = true;
     },
     saveClicked: function(e)
     {
      // Store the selectedItem unconditionally.
      var id = 0;    // Record ID.
      var il = 0;    // View Length.
      var ix = 0;    // Record index.
      var pd = "";   // Post Data.
      var ur = "";   // URL to POST.
      var vw = null; // Available Records.
      var vx = null; // Current Record.
      if(this.selectedItem != null)
      {
       id = this.selectedItem.CustomerID;
       vw = this.packageSource.data();
       il = vw.length;
       for(ix = 0; ix < il; ix ++)
       {
        if(vw[ix].CustomerID == id)
        {
         // Record ID found.
         vx = vw[ix];
         //vx.dirty = true;
         console.log("Change Override: " + kendo.stringify(vx));
         ur = "api/Customers/" + vx.CustomerID.toString();
         pd = $.param(simpleValue("Customer", vx), true);
         console.log("Prepare to send: " + pd);
         console.log(" to : " + ur);
         $.ajax({
          dataType: "json",
          type: "POST",
          url: ur,
          data: pd,
          success: function(result)
          {
           console.log(" Record stored successfully...");
          },
          error: function(result)
          {
           console.log(" Error storing record...");
          }
         });
         break;
        }
       }
       console.log("Save clicked Event.");
       this.set("isSaveEnabled", false);
       this.set("hasChanges", false);
      }
     }
    });

    // Initialize the main tab strip.
    $("#tabstrip").kendoTabStrip({
     animation: {
      open: {
       effects: "fadeIn"
      }
     },
     activate: function(e)
     {
      alert("Tab: " + e.item.text);
     }
    });

    // Initialize the Accounts datagrid.
    $("#dgAccounts").kendoGrid({
     dataSource: accountData,
     height: 550,
     groupable: true,
     sortable: true,
     selectable: "row",
     pageable: {
      refresh: true,
      pageSizes: true,
      buttonCount: 5
     },
     columns: [{
      template: '<div class="record-icon"' +
      'style="background-image: url(Images/Account.png);"></div>' +
      '<div class="record-name">#: AccountTicket #</div>',
      field: "AccountTicket",
      title: "AccountTicket",
      width: 240
     }, {
      // TODO: Convert CustomerID to customer name.
      // TODO: Add account grid.
      // TODO: Add account form fields.
      field: getCustomerName("CustomerID"),
      title: "Customer"
     }, {
      field: "BalanceAvailable",
      title: "BalanceAvailable"
     }, {
      field: "City",
      title: "City"
     }, {
      field: "ZipCode",
      title: "Zip Code",
      width: 150
     }],
     change: function(e)
     {
      var selectedRow = this.select();
      if(selectedRow)
      {
       var dataItem = this.dataItem(selectedRow);
       if(dataItem)
       {
        // Update the selected item on the View Model.
        var v = customerViewModel;
        if(v)
        {
         console.log("ViewModel found. Setting selected customer...");
         // Important: Use the 'set' function, or notifications don't get sent.
         v.set("selectedItem", dataItem);
        }
        // Display the customer form.
        $("#pnlMain").addClass("hidden");
        $("#pnlCustomer").removeClass("hidden");
       }
      }
     }
    });

    // Initialize the Customers datagrid.
    $("#dgCustomers").kendoGrid({
     dataSource: customerData,
     height: 550,
     groupable: true,
     sortable: true,
     selectable: "row",
     pageable: {
      refresh: true,
      pageSizes: true,
      buttonCount: 5
     },
     columns: [{
      template: '<div class="record-icon"' +
      'style="background-image: url(Images/Customer.png);"></div>' +
      '<div class="record-name">#: Name #</div>',
      field: "Name",
      title: "Name",
      alttemplate: '<a href="Customer.html?id=#=CustomerID#" ' +
       ' target="blank">#=Name#</a>',
      width: 240
     }, {
      field: "Address",
      title: "Address"
     }, {
      field: "City",
      title: "City"
     }, {
      field: "ZipCode",
      title: "Zip Code",
      width: 150
     }],
     change: function(e)
     {
      var selectedRow = this.select();
      if(selectedRow)
      {
       var dataItem = this.dataItem(selectedRow);
       if(dataItem)
       {
        // Update the selected item on the View Model.
        var v = customerViewModel;
        if(v)
        {
         console.log("ViewModel found. Setting selected customer...");
         // Important: Use the 'set' function, or notifications don't get sent.
         v.set("selectedItem", dataItem);
        }
        // Display the customer form.
        $("#pnlMain").addClass("hidden");
        $("#pnlCustomer").removeClass("hidden");
       }
      }
     }
    });

    // Bind all of the controls to their view models.
    kendo.bind($("#dgCustomers"), customerViewModel);
    kendo.bind($("#frmCustomer"), customerViewModel);
    kendo.bind($("#dgAccounts"), accountViewModel);
    kendo.bind($("#frmAccount"), accountViewModel);

    // Set additional control behaviors.
    setReadOnly("#customerTicket");
    setReadOnly("#accountTicket");

    // Read first page data.
    customerData.read();
   }
   catch(ex)
   {
    alert("Error: " + ex.message);
   }
  });
  // /document.ready.

 </script>

</body>
</html>
